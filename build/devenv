#!/usr/bin/env ruby

$: << File.expand_path(File.dirname(__FILE__))

require 'rubygems'
require 'thor'
require 'fileutils'
require 'lib/openshift'
require 'pp'

include OpenShift::AWS

class DevEnv < Thor
  include Thor::Actions

  desc "build", "build a new devenv AMI"
  method_option :name, :required => true, :desc => "The unique AMI name"
  method_option :terminate, :type => :boolean, :desc => "Terminate the instance when finished"
  method_option :reboot, :type => :boolean, :desc => "Reboot the instance after updating"
  def build
    # See if any updates are needed
    pkgs = check_update
    exit_msg "Nothing to update" if pkgs.empty?

    # Establish a new connection
    conn = connect

    # Create a new builder instance
    instance = Instance.create(conn, options[:name])

    begin
      print "Uploading devenv script..."
      script_path = File.expand_path(File.dirname(__FILE__) + "/../misc/devenv/li-devenv.sh")
      instance.scp_to(script_path, "~/")
      puts "Done"

      print "Performing clean install with the latest code..."
      output = instance.ssh('sh li-devenv.sh', 1800)
      puts "Done"

      puts "----------------- Install Output ------------------------"
      puts output
      puts "---------------------------------------------------------"

      print "Updating all packages on the system..."
      instance.ssh('yum update -y', 1800)
      puts "Done"

      if options.reboot?
        print "Rebooting instance to apply new kernel..."
        instance.reboot
        puts "Done"
      end

      # Validate the node installation
      print "Validating instance..."
      unless instance.is_valid?
        puts "ERROR - instance is not valid"
        exit 1
      end
      puts "Done"

      print "Retrieving RPM manifest"
      manifest = instance.ssh('rpm -qa | grep rhc-')
      manifest = manifest.split("\n").sort.join(" / ")
      # Trim down the output to 255 characters
      manifest.gsub!(/rhc-([a-z])/, '\1')
      manifest.gsub!('.el6.noarch', '')
      manifest.gsub!('cartridge', 'c-')
      manifest = manifest[0..254]
      puts "Done"

      print "Registering AMI..."
      Image.register(conn, instance.amz_id, options[:name], manifest)
      puts "Done"
    ensure
      instance.terminate if options.terminate?
    end
  end

  desc "update", "Update a DevEnv environment with local RPM installations"
  method_option :verbose, :type => :boolean, :desc => "Enable verbose logging"
  def update
    # Warn on uncommitted changes
    `git diff-index --quiet HEAD` 
    puts "WARNING - Uncommitted repository changes" if $? != 0

    remove_dir '/tmp/tito/'

    # Figure out what needs to be built
    packages = `tito report --untagged-commits | grep rhc`
    build_dirs = packages.split("\n").collect do |package|
      if package =~ /rhc-devenv-0/
        "misc/devenv/"
      elsif package =~ /rhc-(cartridge-.*)-0/
        "cartridges/" + $1['cartridge-'.length, $1.length]
      elsif package =~ /rhc-(.*)-0/
        $1
      else
        "client"
      end
    end

    puts "Changes detected in the following directories: #{build_dirs.pretty_inspect}"

    # Build and install them
    build_dirs.each do |build_dir|
      Dir.glob(build_dir).each do |dir|
        inside(dir) do
          exit 1 unless run('tito build --rpm --test --install', :verbose => options.verbose?)
        end
      end
    end
  end
end

DevEnv.start
