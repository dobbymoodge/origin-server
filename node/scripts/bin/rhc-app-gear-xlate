#!/bin/bash

#
# In a particular path (ex: .env), make variable name translations
#

wp="$1"

if [ -z "$wp" ]
then
  echo "ERROR: Working path is not a directory: $wp"
  exit 65  
fi

if ! [ -d "$wp" ]
then 
  echo "ERROR: Working path is not a directory: $wp"
  exit 66
fi  

cd $wp

XLATION=( \
  OPENSHIFT_10GEN_MMS_AGENT_APP_DIR \
  OPENSHIFT_APP_CTL_SCRIPT \
  OPENSHIFT_APP_DIR \
  OPENSHIFT_APP_DNS \
  OPENSHIFT_APP_NAME \
  OPENSHIFT_APP_STATE \
  OPENSHIFT_APP_TYPE \
  OPENSHIFT_METRICS_APP_DIR \
  OPENSHIFT_PHPMOADMIN_APP_DIR \
  OPENSHIFT_PHPMYADMIN_APP_DIR \
  OPENSHIFT_ROCKMONGO_APP_DIR \
  OPENSHIFT_APP_UUID \
 )

export TRANSLATE_GEAR_VARS=""
if [ -f TRANSLATE_GEAR_VARS ]; then
  source TRANSLATE_GEAR_VARS
fi

for xlate in "${XLATION[@]}"
do
  dst=$(echo "$xlate" | sed -e 's/APP/GEAR/')
  if [ -f "$xlate" -a \! -f "$dst" ]
  then
    sed -e s\|"$xlate"\|"$dst"\|g "$xlate" > "$dst"
    chown root:root "$dst"
    chmod 0644 "$dst"
    chcon --reference="$xlate" "$dst"
    if [ "$xlate" != "OPENSHIFT_APP_UUID" ]; then
      TRANSLATE_GEAR_VARS="$xlate $dst ${TRANSLATE_GEAR_VARS}"
      echo "export TRANSLATE_GEAR_VARS=\"${TRANSLATE_GEAR_VARS}\"" > TRANSLATE_GEAR_VARS
      chown root:root TRANSLATE_GEAR_VARS
      chmod 0644 TRANSLATE_GEAR_VARS
      chcon --reference="$xlate" TRANSLATE_GEAR_VARS
      rm -f "$xlate"
    fi
  fi
done

exit 0
