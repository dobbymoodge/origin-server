#!/usr/bin/ruby

# Purpose: Chcon /var/lib/stickshift to proper mcs contexts
#
# Type should generally be libra_var_lib_t
# MCS should be s0:c$UID-499  so UID500 has a mcs of s0:c1

require 'etc'

home_dirs = Dir.glob("/var/lib/stickshift/[0-9a-zA-Z]*")

debug=1

def get_mcs_level(uid)
  setsize=1023
  tier=setsize
  ord=uid
  while ord > tier
    ord -= tier
    tier -= 1
  end
  tier = setsize - tier
  "s0:c#{tier},c#{ord + tier}"
end

home_dirs.each do |home_dir|
    if File.directory? home_dir
        begin
            username = home_dir.split('/')[-1]
            user = Etc.getpwnam(username)
            mcs_level = get_mcs_level(user.uid)
            puts "chcon -t libra_var_lib_t -l #{mcs_level} -R #{home_dir}/[^.]*" if debug
            puts "chcon -t libra_tmp_t -l #{mcs_level} -R #{home_dir}/.tmp/*" if debug
            %x[chcon -t libra_var_lib_t -l #{mcs_level} -R #{home_dir}/[^.]* ]
            %x[chcon -t libra_tmp_t -l #{mcs_level} -R #{home_dir}/.tmp/* ]
        rescue ArgumentError
            puts "Warning: #{home_dir} is not owned by #{user} - #{$!}"
        end
    end
end

