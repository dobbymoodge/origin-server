#!/usr/bin/env ruby
# Script to detect whether the app has not been accessed
# for the specified number of hours
require 'date'
OPENSHIFT_GEAR_UUID = ARGV[0]
IDLE_FOR = ARGV[1].to_i
LAST_ACCESS_DIR = '/var/lib/openshift/.last_access'

file_path = "#{LAST_ACCESS_DIR}/#{OPENSHIFT_GEAR_UUID}"
exit 6 unless File.exists?(file_path)

File.open(file_path, 'r') do |file|
  last_access_time = file.read
  d1 = DateTime.strptime(last_access_time, "%d/%b/%Y:%H:%M:%S %Z")
  d2 = DateTime.now
  hours,minutes,seconds,frac = Date.day_fraction_to_time(d2 - d1)
  if hours >= IDLE_FOR * 24
    exit 0
  else
    # We return 5 since 1 is returned on exceptions
    exit 5
  end
end
