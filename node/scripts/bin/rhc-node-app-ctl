#!/bin/bash

UUID=$1
ACTION=$2

function print_help {
    echo "Usage: $0 UUID ACTION (eg: $0 2e08d1169e654a5b9a532ce3740325b2 stop)"
    exit 1
}

function openshift_mcs_level() {
    # UID=$1

    SETSIZE=1023
    TIER=$SETSIZE

    ORD=$1
    while [ $ORD -gt $(($TIER)) ] ; do
        ORD=$(($ORD - $TIER))
        TIER=$(($TIER - 1))
    done
    TIER=$(($SETSIZE - $TIER))
    echo s0:c$TIER,c$(($ORD + $TIER))
}

export uid=$(id -u "$1")
export mcs_level=`openshift_mcs_level $uid`

while getopts 'd' OPTION
do
    case $OPTION in
        d) set -x
        ;;
        ?) print_help
        ;;
    esac
done

[ $# -eq 2 ] || print_help


if [ ! -d /var/lib/libra/$UUID ]
then
	echo "Cannot find /var/lib/libra/$UUID"
	exit 2
fi

for env_var in /var/lib/libra/$UUID/.env/*_CTL_SCRIPT
do
    . $env_var
done

for cmd in `awk 'BEGIN { for (a in ENVIRON) if (a ~ /_CTL_SCRIPT$/) print ENVIRON[a] }'`
do
    echo "+ /usr/bin/runcon system_u:system_r:libra_initrc_t:s0-s0:c0.c1023 /sbin/runuser $UUID /usr/bin/runcon -t libra_t -l $mcs_level $cmd $ACTION"
    /usr/bin/runcon system_u:system_r:libra_initrc_t:s0-s0:c0.c1023 \
        /sbin/runuser --shell /bin/sh "$UUID" -c \
        "/usr/bin/runcon -t libra_t -l $mcs_level $cmd $ACTION"

   #runuser --shell /bin/sh "$uuid" -c "runcon -t libra_t -l $mcs_level $cmd start" || error "Failed to start ${application}" 121
done


