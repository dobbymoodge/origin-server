#!/usr/bin/ruby

# Purpose: Chcon /var/lib/libra to proper mcs contexts
#
# Type should generally be libra_var_lib_t
# MCS should be s0:c$UID-499  so UID500 has a mcs of s0:c1

require 'etc'

home_dirs = Dir.glob("/var/lib/libra/[0-9a-zA-Z]*")

debug=1

home_dirs.each do |home_dir|
    if File.directory? home_dir
        begin
            username = home_dir.split('/')[-1]
            user = Etc.getpwnam(username)
            c_val = user.uid.divmod(1023)
            puts "chcon -t libra_var_lib_t -l s0:c#{c_val[0]},c#{c_val[1]} -R #{home_dir}/[^.]*" if debug
            %x[chcon -t libra_var_lib_t -l s0:c#{c_val[0]},c#{c_val[1]} -R #{home_dir}/[^.]*]
        rescue ArgumentError
            puts "Warning: #{home_dir} is not owned by #{user} - #{$!}"
        end
    end
end

