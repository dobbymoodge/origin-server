#!/bin/sh

# named-local init
# named-local start
# named-local status
# named-local stop
# named-local clean
# named-local reset

# Where to get the init files from
NAMED_LOCAL_LIB=${NAMED_LOCAL_LIB:="/usr/share/bind-local"}
# Where to put them to work
NAMED_LOCAL_DIR=.

# The requirements to run a local named are:
#   named.conf
#   example.com.key
#   example.com.db
# 


#
# Prepare a to run a named
#
function init() {
    echo "init"
    # copy named.conf
    cp ${NAMED_LOCAL_LIB}/named.conf ${NAMED_LOCAL_DIR}
    # copy example.com.db
    cp ${NAMED_LOCAL_LIB}/example.com.db.init ${NAMED_LOCAL_DIR}/example.com.db
}

function start() {
    echo "start"
    if [ ! -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	/usr/sbin/named -4 -c ${NAMED_LOCAL_DIR}/named.conf
    else
	echo "${NAMED_LOCAL_DIR}/named.pid found: is there a named running?"
	exit 1
    fi
}

function stop() {
    echo "stop"
    if [ -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	PID=`cat ${NAMED_LOCAL_DIR}/named.pid`
	kill $PID
    else
	echo "${NAMED_LOCAL_DIR}/named.pid is not found.  Is there a named running?"
    fi
}

function status() {
    echo "status"
    if [ -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	PID=`cat ${NAMED_LOCAL_DIR}/named.pid`
	ps --no-heading -p $PID
    else
	echo no named.pid found
	exit 1
    fi
}

function clean() {
    echo "clean"
    if [ ! -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	rm -f ${NAMED_LOCAL_DIR}/named.conf
	rm -f ${NAMED_LOCAL_DIR}/example.com.db
	rm -f ${NAMED_LOCAL_DIR}/example.com.db.jnl
	rm -f ${NAMED_LOCAL_DIR}/named.log
	rm -f ${NAMED_LOCAL_DIR}/named.session.key
    else
	echo "$NAMED_LOCAL_DIR/named.pid exists: Is there a named running?"
    fi
}

function reset() {
    echo "reset"
    stop
    clean
    init
}


ACTION=$1

case $ACTION in

    "start")
	start
	;;

    "stop")
	stop
	;;

    "status")
	status
	;;

    "init")
	init
	;;

    "clean")
	clean
	;;

    "reset")
	reset
	;;

    *)
	echo "invalid command $ACTION"
	exit 1
	;;
esac

