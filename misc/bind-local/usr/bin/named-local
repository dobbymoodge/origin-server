#!/bin/sh

# named-local init
# named-local start
# named-local status
# named-local stop
# named-local clean
# named-local reset

# options: -l: where to find init file copies
# options: -r: where to put the running copies

# Where to get the init files from
NAMED_LOCAL_LIB=${NAMED_LOCAL_LIB:="/usr/share/bind-local"}
# Where to put them to work
NAMED_LOCAL_DIR=.

# The requirements to run a local named are:
#   named.conf
#   example.com.key
#   example.com.db
# 


#
# Prepare a to run a named
#
function init() {
    echo "init"
    # copy named.conf
    cp ${NAMED_LOCAL_LIB}/named.conf ${NAMED_LOCAL_DIR}
    # copy example.com.db
    cp ${NAMED_LOCAL_LIB}/example.com.db.init ${NAMED_LOCAL_DIR}/example.com.db
}

function start() {
    echo "start"
    if [ ! -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	OPWD=`pwd`
	cd ${NAMED_LOCAL_DIR}
	/usr/sbin/named -4 -c ${NAMED_LOCAL_DIR}/named.conf
	cd $OPWD
    else
	echo "${NAMED_LOCAL_DIR}/named.pid found: is there a named running?"
	exit 1
    fi
}

function stop() {
    echo "stop"
    if [ -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	PID=`cat ${NAMED_LOCAL_DIR}/named.pid`
	kill $PID
    else
	echo "${NAMED_LOCAL_DIR}/named.pid is not found.  Is there a named running?"
    fi
}

function status() {
    echo "status"
    if [ -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	PID=`cat ${NAMED_LOCAL_DIR}/named.pid`
	ps --no-heading -p $PID
    else
	echo no named.pid found
	exit 1
    fi
}

function clean() {
    echo "clean"
    if [ ! -f ${NAMED_LOCAL_DIR}/named.pid ]
    then
	rm -f ${NAMED_LOCAL_DIR}/named.conf
	rm -f ${NAMED_LOCAL_DIR}/example.com.db
	rm -f ${NAMED_LOCAL_DIR}/example.com.db.jnl
	rm -f ${NAMED_LOCAL_DIR}/named.log
	rm -f ${NAMED_LOCAL_DIR}/named.session.key
    else
	echo "$NAMED_LOCAL_DIR/named.pid exists: Is there a named running?"
    fi
}

function reset() {
    echo "reset"
    stop
    clean
    init
}

function usage() {
    echo "
usage $0 [options] [command]

options:

  -r <dir>: where to put the config and log files for the daemon
            defaults to CWD

  -l <dir>: where to get the initial config files
            defaults to /usr/share/bind-local

commands:

  start: start the local named

  stop: stop the local named

  status: get the PID and process information for a running named

  init: copy initial config files to the daemon "root"

  clean: remove config files and logs

  reset: clean and re-initialize the local daemon
"
    
}


while getopts l:r: OPT
do
    case "$OPT" in
	l)
	    NAMED_LOCAL_LIB="$OPTARG"
	    ;;

	r)
	    NAMED_LOCAL_DIR="$OPTARG"
	    ;;

	*)
	    echo "Invalid argument: $OPT"
	    usage
	    exit 1
	    ;;
    esac
done
if [ $OPTIND -gt 1 ]
then
    shift $(($OPTIND-1))
fi

ACTION=$1

case $ACTION in

    "start")
	start
	;;

    "stop")
	stop
	;;

    "status")
	status
	;;

    "init")
	init
	;;

    "clean")
	clean
	;;

    "reset")
	reset
	;;

    *)
	echo "invalid command $ACTION"
	usage
	exit 1
	;;
esac

