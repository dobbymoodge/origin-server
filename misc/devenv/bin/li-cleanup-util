#!/usr/bin/ruby
require 'rubygems'
require '/var/www/stickshift/broker/config/environment'

opts = GetoptLong.new(["--namespace",  "-n", GetoptLong::REQUIRED_ARGUMENT])
opt = {}
opts.each do |o, a|
    opt[o[2..-1]] = a.to_s
end

$dns = Express::Broker::DnsService.new

def users_delete
  ds = StickShift::MongoDataStore.new

  users = ds.find_all("CloudUser")
  users.each do |user|
    cloud_user = CloudUser.find(user['login'])
    cloud_user.delete
  end if users
end

if opt['namespace']
  $dns.deregister_namespace(opt['namespace'])
else 
  users_delete
end

$dns.publish
$dns.close
