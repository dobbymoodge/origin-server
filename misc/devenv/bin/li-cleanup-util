#!/usr/bin/env oo-ruby
require 'rubygems'
require '/var/www/openshift/broker/config/environment'

opts = GetoptLong.new(
    ["--user",             "-u", GetoptLong::REQUIRED_ARGUMENT],
    ["--all",              "-a", GetoptLong::NO_ARGUMENT]
)

args = {}
begin
    opts.each{ |k,v| args[k]=v }
rescue GetoptLong::Error => e
    exit 1
end



def delete_all_users
  ds = OpenShift::DataStore.instance
  users = ds.find_all("CloudUser")
  users.each do |user|
    delete_user((user['login']))
  end if users
end

def delete_user(login)
  puts "deleting user #{login}"
  begin
    cloud_user = CloudUser.find(login)
    cloud_user.force_delete
  rescue Exception => e
    puts "failed to delete user #{} #{e.message}"
  end
end

if args["--user"]
  delete_user(args["--user"])
elsif args["--all"]
  delete_all_users
else
  puts "You must use --user to delete a specific user or --all to delete all users"
  exit 1
end


