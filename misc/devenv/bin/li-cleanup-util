#!/usr/bin/env oo-ruby
require 'rubygems'
require '/var/www/openshift/broker/config/environment'

opts = GetoptLong.new(
    ["--user",             "-u", GetoptLong::REQUIRED_ARGUMENT],
    ["--all",              "-a", GetoptLong::NO_ARGUMENT]
)

args = {}
begin
    opts.each{ |k,v| args[k]=v }
rescue GetoptLong::Error => e
    exit 1
end



def delete_all_users
  puts "Deleting all users..."
  CloudUser.each do |user|
    begin
      user.force_delete
    rescue Exception => e
      puts "ERROR: Delete user #{user.login} failed: #{e.message}"
    end  
  end
  puts "Done"
end

def delete_user(login)
  puts "Deleting user #{login}..."
  begin
    user = CloudUser.find_by(login: login)
    user.force_delete
  rescue Exception => e
    puts "ERROR: Delete user #{login} failed: #{e.message}"
  end
  puts "Done"
end

if args["--user"]
  delete_user(args["--user"])
elsif args["--all"]
  delete_all_users
else
  puts "You must use --user to delete a specific user or --all to delete all users"
  exit 1
end


