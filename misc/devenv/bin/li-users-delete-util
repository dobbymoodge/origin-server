#!/usr/bin/ruby
require 'rubygems'
require '/var/www/libra/broker/config/environment'

def users_delete
  ds = Cloud::Sdk::MongoDataStore.new
  dns = Express::Broker::DnsService.new

  users = ds.find_all("CloudUser")
  users.each do |user|
    user['apps'].each do |app_info|
      dns.deregister_application(app_info['name'], user['namespace'])
    end if user['apps']
    dns.deregister_namespace(user['namespace'])
    ds.delete("CloudUser", user['login'])
  end if users
  dns.publish
  dns.close
end

users_delete 
