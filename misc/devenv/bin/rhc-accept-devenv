#!/usr/bin/env oo-ruby

output = `oo-accept-node`
exit_code = $?.exitstatus
if exit_code != 0
  puts "Accept Node Output: #{output}"
  exit exit_code
end

output = `service rhc-site status`
exit_code = $?.exitstatus
if exit_code != 0
  puts "Site Status Output: #{output}"
  exit exit_code
end

output = `service rhc-broker status`
exit_code = $?.exitstatus
if exit_code != 0
  puts "Broker Status Output: #{output}"
  exit exit_code
end

status_code = `curl -s -w %{http_code} --output /dev/null --insecure https://localhost/app/login`
if status_code != '200'
  puts "Tailing last 100 lines of /var/log/openshift/site/httpd/error_log"
  puts `tail -n 100 /var/log/openshift/site/httpd/error_log`
  puts "\n\n"
  puts "Tailing last 100 lines of /var/log/openshift/site/development.log"
  puts `tail -n 100 /var/log/openshift/site/development.log`
  puts "****Site returned a status code of #{status_code}"
  exit 1
end

status_code = `curl -s -w %{http_code} --output /dev/null --user test:test --insecure  https://localhost/broker/rest/cartridges/standalone`
if status_code != '200'
  puts "Tailing last 100 lines of /var/log/openshift/broker/httpd/error_log"
  puts `tail -n 100 /var/log/openshift/broker/httpd/error_log`
  puts "\n\n"
  puts "Tailing last 100 lines of /var/log/openshift/broker/development.log"
  puts `tail -n 100 /var/log/openshift/broker/development.log`
  puts "****Broker returned a status code of #{status_code}"
  exit 1
end

puts 'PASS'
