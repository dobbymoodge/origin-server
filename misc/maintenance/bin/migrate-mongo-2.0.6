#!/usr/bin/env ruby
# Usage: ./migrate-mongo-2.0.6 > out.txt

$:.unshift('/var/www/libra/broker')
require 'config/environment'

ds = StickShift::DataStore.instance
users = ds.class.collection.find({"apps.requires_feature" => 'jbossas-7.0' })
users.each do |user|
  print "Processing user #{user["_id"]}\n"
  if user["apps"]
    user["apps"].each do |app|
      if app['requires_feature'].include?('jbossas-7.0')
        puts "\tProcessing app #{app["name"]}"
        app_json = app.to_json
        app_json.gsub!(/jbossas-7.0/, 'jbossas-7')
        app = JSON.parse(app_json)
        ds.class.put_app(user['_id'], app["name"], app)
      end
    end
  else
    print "\tNo apps found. skipping\n"
  end
end

