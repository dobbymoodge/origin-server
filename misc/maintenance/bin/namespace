#!/usr/bin/env ruby
# Usage: ./namespace register --login=foo --namespace=bar --public_key=baz
require 'rubygems'
require 'openshift'
require 'thor'
require 'mocha'
require 'pp'

class Namespace < Thor
  include Thor::Actions
  include Libra


  desc "register", "Registers a namespace without checking the reserved list"
  method_option :login, :required => true, :desc => "The OpenShift login"
  method_option :namespace, :required => true, :desc => "The namespace to register"
  method_option :public_key, :required => true, :desc => "The public SSH key for the user"
  def register
    login = options[:login]
    namespace = options[:namespace]
    key = options[:public_key]

    # Clean up the debug logging
    Libra.expects(:logger_debug).at_least_once

    # Verify it's a real login
    user = Libra::User.new(login, nil, nil, nil, nil)
    user.establish_email_address
    if user.email_address
      puts "Successfully verified login - #{login} (email = #{user.email_address})"
    else
      puts "ERROR - #{login} didn't resolve to a RH user."
      exit 1
    end

    user = Libra::User.create(login, key, namespace)
    if user
      puts "Successfully registered domain."
    end
  end
end

Namespace.start
