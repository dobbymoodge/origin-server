#!/usr/bin/env oo-ruby
require 'rubygems'
$:.unshift('/var/www/openshift/broker')
require 'config/environment'

#####################
# This migrate script will migrate aliases for all existing apps
#####################

if ARGV.include? "--verbose"
  $verbose = true
else
  $verbose = false
end

def mongo_connect
  db = OpenShift::DataStore.db
  $coll = db.collection('applications')
end

def migrate_apps
  query = {"aliases.0" => {"$exists" => true}}
  selection = {:fields => ["name",
                         "aliases",
                         "uuid"], :timeout => false}

  total = 0
  $coll.find(query, selection) do |cursor| 
    cursor.each do |app|
      new_aliases = []
      app["aliases"].each do |old_alias|
        if old_alias.is_a?(Hash) and old_alias.has_key? "_id" and old_alias.has_key? "fqdn"
          new_aliases << old_alias
        elsif old_alias.is_a?(String)
          new_aliases << { "_id" => BSON::ObjectId.new, "fqdn" => old_alias,  "has_private_certificate" => false }
        else
          raise Exception.new("Alias #{old_alias} for app #{app["name"]} does not follow any of the expected formats")
        end
      end
      print "."
      print "Migrating app #{app['name']}/#{app['uuid']}.. " if $verbose
      $coll.update({ "uuid" => app["uuid"] }, { "$set" => { "aliases" => new_aliases } } ) if new_aliases.length > 0
      print "done" if $verbose
    end
  end
  puts
  puts "Mongo migrated #{total} apps"
end

puts "Starting migration"
mongo_connect
migrate_apps
puts "Done!"
