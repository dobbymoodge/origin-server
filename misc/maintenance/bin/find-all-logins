#!/usr/bin/env ruby

require 'rubygems'
require 'parseconfig'
require 'thor'
require 'fileutils'
require 'aws'
require 'pp'

class Accounts < Thor
  include Thor::Actions

  desc "list", "list all OpenShift accounts"
  method_option :bucket, :required => true, :desc => "The S3 bucket (e.g. libra_dev, rhc_prod)"
  def list

    config = nil
    begin
      # Parse the credentials
      puts ParseConfig.new(File.expand_path("~/.awscred"))

      puts "Reading config for permissions"
      puts "Read it"
      config = ParseConfig.new(File.expand_path("~/.awscred"))
      puts "Done"

    rescue StandardError => e
      puts <<-eos
        Couldn't access credentials in ~/.awscred

        Please create a file with the following format:
          AWSAccessKeyId=<ACCESS_KEY>
          AWSSecretKey=<SECRET_KEY>
      eos
      raise "Error - no credentials"
    end

    # Return the AMZ connection
    s3 = Aws::S3Interface.new(config.get_value("AWSAccessKeyId"), 
                 config.get_value("AWSSecretKey"), 
                 params = {:logger => Logger.new('/dev/null')})

    rhlogins = []
    s3.incrementally_list_bucket('libra_dev', {'prefix' => 'user_info'}) do |result|
      result[:contents].each do |bucket|  
        if bucket[:key] =~ /\/user.json$/
          rhlogins << File.basename(File.dirname(bucket[:key]))                                                                
        end
      end
    end

    pp rhlogins
  end
end

Accounts.start
