#!/usr/bin/env oo-ruby
require 'rubygems'
$:.unshift('/var/www/openshift/broker')
require 'config/environment'

begin
  db = OpenShift::DataStore.db(:primary)

  puts "Before:"
  a = db["applications"].find_one({"uuid" => "51b552d4e0b8cd8dde00003d"})

  puts a['group_instances'].class
  a['group_instances'].each_with_index do |gi, index|
    puts gi['gears'].class
    puts gi['_id']
    gi['gears'].each do |gear|
      if gear['uid'] == 3282
        puts 'Updating...'
        a['group_instances'].delete_at(index)
        db["applications"].update({"uuid" => "51b552d4e0b8cd8dde00003d"}, {"$set" => {"group_instances" => a['group_instances']}})
        break
      end
    end
  end
  
  puts "After:"
  puts db["applications"].find_one({"uuid" => "51b552d4e0b8cd8dde00003d"}).pretty_inspect
  
rescue Exception => e
  puts e.message
  puts e.backtrace
  exit 1
end
puts "Migration Done!"
