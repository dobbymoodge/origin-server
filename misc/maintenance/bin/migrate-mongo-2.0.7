#!/usr/bin/env ruby
# Usage: ./migrate-mongo-2.0.7 > out.txt

$:.unshift('/var/www/stickshift/broker')
require 'config/environment'

ds = StickShift::DataStore.instance
users = ds.collection.find({"apps.requires_feature" => 'raw-0.1' })
users.each do |user|
  print "Processing user #{user["_id"]}\n"
  if user["apps"]
    user["apps"].each do |app|
      if app['requires_feature'].include?('raw-0.1')
        puts "\tProcessing app #{app["name"]}"
        app_json = app.to_json
        app_json.gsub!(/raw-0.1/, 'diy-0.1')
        app = JSON.parse(app_json)
        ds.save("Application", user['_id'], app["name"], app)
      end
    end
  else
    print "\tNo apps found. skipping\n"
  end
end

