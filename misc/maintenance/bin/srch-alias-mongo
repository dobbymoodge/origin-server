#!/usr/bin/env oo-ruby
# -*- ruby -*-

require 'rubygems'
require 'mongo'
require 'json'
$:.unshift('/var/www/openshift/broker')
require 'config/environment'

# Configurable params
def mongo_connect
  db = OpenShift::DataStore.db
  $coll = db.collection('applications')
end

def alias_searches(reqaliases)
  $coll.find({ "aliases.0" => { "$exists" => true } },
             { :fields => ["aliases", "name"] } ) do |cursor|
    cursor.each do |hash|

      id = hash["_id"]
      name = hash["name"]

      if hash["aliases"] != nil

        hash["aliases"].each do |server_alias|
        
          # Would we have rejected this alias
          reqaliases.each do |rqalias|
            if server_alias == rqalias
              puts "#{server_alias}: #{id}: #{name}"
            end
          end
                      
        end
      end
    end
  end

end

mongo_connect
alias_searches(ARGV)
