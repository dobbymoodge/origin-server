#!/usr/bin/env oo-ruby
require 'rubygems'
$:.unshift('/var/www/openshift/broker')
require 'config/environment'

#####################
# This migrate script will execute connections for all scalable apps
#####################

puts "Starting migration"

count = 0
total = Application.no_timeout.where({ "scalable" => true, "group_instances.gears.1" => { "$exists" => true } }).each { |app|
  next if app.uuid==app._id.to_s
  print "."
  begin
    Application.run_in_application_lock(app) do
      app.execute_connections
    end
  rescue Exception=>e
    puts e.message
    puts e.backtrace
  end
  count += 1
}.count

puts
puts "Fixed #{count} out of #{total} candidate applications."

