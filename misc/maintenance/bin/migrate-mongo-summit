#!/usr/bin/env oo-ruby
require 'rubygems'
$:.unshift('/var/www/openshift/broker')
require 'config/environment'

begin
  db = OpenShift::DataStore.db(:primary)
  puts "Enable Plan Upgrade capability for all existing users..."
  update_query = {"$set" => {"capabilities.plan_upgrade_enabled" => true}}
  db["cloud_users"].update({}, update_query, { :multi => true })

  count = db["cloud_users"].find({"capabilities.plan_upgrade_enabled" => false}).count
  raise Exception.new "Failed to enable Plan Upgrade capability for #{count} users" if count != 0
rescue Exception => e
  puts e.message
  puts e.backtrace
  exit 1
end
puts "Migration Done!"
