#!/bin/bash -e
set -u
set -x

case "$1" in
  -v|--version)
    version="$2"
esac

if [ "$version" != "5.6" ]
then
    echo "Version \"$version\" not supported."
fi

#OPENSHIFT_ZEND_DIR="$OPENSHIFT_HOMEDIR/zend/"
#export OPENSHIFT_ZEND_DIR

echo "export OPENSHIFT_ZEND_VERSION='$version'" > "$OPENSHIFT_ZEND_DIR/env/OPENSHIFT_ZEND_VERSION"

# Copy the version specific files up to zend directory
shopt -s dotglob
mkdir -p $OPENSHIFT_ZEND_DIR/configuration/etc/conf.d
cp $OPENSHIFT_ZEND_DIR/versions/$version/configuration/etc/conf.d/* $OPENSHIFT_ZEND_DIR/configuration/etc/conf.d/

mkdir -p $OPENSHIFT_ZEND_DIR/configuration/etc/conf
cp $OPENSHIFT_ZEND_DIR/versions/$version/configuration/etc/conf/* $OPENSHIFT_ZEND_DIR/configuration/etc/conf/

#php.ini?

cp -r $OPENSHIFT_ZEND_DIR/versions/$version/metadata/* $OPENSHIFT_ZEND_DIR/metadata
cp -r $OPENSHIFT_ZEND_DIR/versions/$version/template/* $OPENSHIFT_ZEND_DIR/template

mkdir -p $OPENSHIFT_ZEND_DIR/zend
cp -r $OPENSHIFT_ZEND_DIR/versions/$version/configuration/user-files/* $OPENSHIFT_ZEND_DIR/zend/


#etc/conf.d/debugger.ini
#gui/application/data/zend-server.ini
#gui/lighttpd/etc/lighttpd.conf
#etc/conf.d/ZendGlobalDirectives.ini

#echo "Replacing ###OPENSHIFT_INTERNAL_IP### with ${IP_ADDRESS} in $zdir/${zfile}"
#sed -i "s/###OPENSHIFT_INTERNAL_IP###/${IP_ADDRESS}/g" $zdir/${zfile}
#echo "Replacing ###UID### with $USER_ID in $zdir/${zfile}"
#sed -i "s/###UID###/${USER_ID}/g" $zdir/${zfile}
#echo "Replacing ###GID### with $GROUP_ID in $zdir/${zfile}"
#sed -i "s/###GID###/${GROUP_ID}/g" $zdir/${zfile}


# Create additional directories required by ZEND
mkdir -p $OPENSHIFT_ZEND_DIR/phplib/pear/{docs,ext,php,cache,cfg,data,download,temp,tests,www}
mkdir -p $OPENSHIFT_ZEND_DIR/{logs,run,tmp,sessions}

# FIXME: delete ~/zend/modules;
# /usr/lib64/httpd/modules/ vs. /usr/local/zend/gui/lighttpd/lib/
ln -s /usr/lib64/httpd/modules $OPENSHIFT_ZEND_DIR/modules
ln -s /etc/httpd/conf/magic $OPENSHIFT_ZEND_DIR/conf/magic

# Pear setup
rm -f $OPENSHIFT_HOMEDIR/.pearrc
pear config-create "$OPENSHIFT_ZEND_DIR"/phplib/pear/ "$OPENSHIFT_HOMEDIR"/.pearrc
pear -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set php_ini "$OPENSHIFT_ZEND_DIR"/versions/shared/configuration/etc/conf/php.ini
pear -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set auto_discover 1
