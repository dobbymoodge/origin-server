#!/bin/bash -eux

source $OPENSHIFT_CARTRIDGE_SDK_BASH

case "$1" in
  -v|--version)
    version="$2"
esac

if [ "$version" != "5.6" ]
then
    echo "Version \"$version\" not supported."
fi

echo "$version" > "$OPENSHIFT_ZEND_DIR/env/OPENSHIFT_ZEND_VERSION"
echo "/usr/local/zend/bin" > "$OPENSHIFT_ZEND_DIR/env/OPENSHIFT_ZEND_PATH_ELEMENT"
echo "$OPENSHIFT_ZEND_DIR/oracle" > "$OPENSHIFT_ZEND_DIR/env/ORACLE_BASE"
echo "$OPENSHIFT_ZEND_DIR/oracle" > "$OPENSHIFT_ZEND_DIR/env/ORACLE_HOME"
mkdir -p $OPENSHIFT_ZEND_DIR/oracle

mkdir -p $OPENSHIFT_ZEND_DIR/template
shopt -s dotglob
cp -r $OPENSHIFT_ZEND_DIR/versions/$version/template/* $OPENSHIFT_ZEND_DIR/template

# Configure Zend specific files

mkdir -p $OPENSHIFT_ZEND_DIR/usr/local/zend
cp -r $OPENSHIFT_ZEND_DIR/versions/$version/configuration/user-files/* $OPENSHIFT_ZEND_DIR/usr/local/zend/

# PAM /sandbox dir
zend_sandbox="/sandbox/zend"

paths=(
"etc"
"tmp"
"var"
"gui/lighttpd/etc"
"gui/lighttpd/logs"
"gui/lighttpd/tmp"
"gui/application/data"
)

# Symlinks the above paths in /sandbox to cartridge directory in the gear
for path in ${paths[*]}; do
    zpath=$zend_sandbox/$path
    zdir=`dirname $zpath`
    zfile=`basename $zpath`
    [ -d "$zdir" ]  ||  mkdir -p $zdir
    ln -s $OPENSHIFT_ZEND_DIR/usr/local/zend/$path $zdir/$zfile
done

# Copy the version specific files up to zend directory
mkdir -p $OPENSHIFT_ZEND_DIR/configuration/etc/conf.d
cp $OPENSHIFT_ZEND_DIR/versions/$version/configuration/etc/conf.d/* $OPENSHIFT_ZEND_DIR/configuration/etc/conf.d/

mkdir -p $OPENSHIFT_ZEND_DIR/configuration/etc/conf
cp $OPENSHIFT_ZEND_DIR/versions/$version/configuration/etc/conf/* $OPENSHIFT_ZEND_DIR/configuration/etc/conf/

# Copy php.ini file
cp $OPENSHIFT_ZEND_DIR/versions/$version/configuration/etc/php.ini $OPENSHIFT_ZEND_DIR/configuration/etc/php.ini

# Symlink php.ini in sandboxed dir, so /usr/local/zend/etc/php.ini is available
ln -s $OPENSHIFT_ZEND_DIR/configuration/etc/php.ini $zend_sandbox/etc/php.ini

# Symlink apachectl in sandboxed dir, /usr/local/zend/bin/apachectl points to the control script
mkdir -p $zend_sandbox/bin
ln -s $OPENSHIFT_ZEND_DIR/bin/control $zend_sandbox/bin/apachectl

# Symlinks referenced from configuration/etc/conf/httpd*.conf files
ln -s /usr/lib64/httpd/modules $OPENSHIFT_ZEND_DIR/modules
ln -s /etc/httpd/conf/magic $OPENSHIFT_ZEND_DIR/conf/magic

# Pear setup
rm -f $OPENSHIFT_HOMEDIR/.pearrc
pear config-create "$OPENSHIFT_ZEND_DIR"/phplib/pear/ "$OPENSHIFT_HOMEDIR"/.pearrc
pear -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set php_ini /usr/local/zend/etc/php.ini
pear -c "$OPENSHIFT_HOMEDIR"/.pearrc config-set auto_discover 1

client_result "Note: You should set password for the Zend Server Console at: https://$OPENSHIFT_APP_DNS/ZendServer"
