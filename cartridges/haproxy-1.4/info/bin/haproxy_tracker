#!/usr/bin/ruby

require 'socket'
require 'logger'

@max_sessions_per_gear=10.0
@gear_down_pct = 50.1
@gear_up_pct = 90.0
@log = Logger.new("#{ENV['OPENSHIFT_LOG_DIR']}/scale_events.log")

class Haproxy_attr
    attr_accessor :pxname,:svname,:qcur,:qmax,:scur,:smax,:slim,:stot,:bin,:bout,:dreq,:dresp,:ereq,:econ,:eresp,:wretr,:wredis,:status,:weight,:act,:bck,:chkfail,:chkdown,:lastchg,:downtime,:qlimit,:pid,:iid,:sid,:throttle,:lbtot,:tracked,:type,:rate,:rate_lim,:rate_max,:check_status,:check_code,:check_duration,:hrsp_1xx,:hrsp_2xx,:hrsp_3xx,:hrsp_4xx,:hrsp_5xx,:hrsp_other,:hanafail,:req_rate,:req_rate_max,:req_tot,:cli_abrt,:srv_abrt

    def initialize(line)
        (@pxname,@svname,@qcur,@qmax,@scur,@smax,@slim,@stot,@bin,@bout,@dreq,@dresp,@ereq,@econ,@eresp,@wretr,@wredis,@status,@weight,@act,@bck,@chkfail,@chkdown,@lastchg,@downtime,@qlimit,@pid,@iid,@sid,@throttle,@lbtot,@tracked,@type,@rate,@rate_lim,@rate_max,@check_status,@check_code,@check_duration,@hrsp_1xx,@hrsp_2xx,@hrsp_3xx,@hrsp_4xx,@hrsp_5xx,@hrsp_other,@hanafail,@req_rate,@req_rate_max,@req_tot,@cli_abrt,@srv_abrt) = line.split(',')
    end
end

class Haproxy
    def initialize(stats_sock)
        socket = UNIXSocket.open("/tmp/stats")
        socket.puts("show stat\n") 

        @status={}

        while(line = socket.gets) do
            pxname=line.split(',')[0]
            svname=line.split(',')[1]
            @status[pxname] = {} unless @status[pxname]
            @status[pxname][svname] = Haproxy_attr.new(line)
            #@status[pxname] = Haproxy_attr.new(line)
        end
        socket.close
    end

    def stats()
        @status
    end

    def scur()
        @scur
    end

end

def check_capacity
    ha=Haproxy.new("/tmp/stats")
    gear_namespace=ENV['OPENSHIFT_APP_DNS'].split('.')[0].split('-')[1]
    gear_count = ha.stats['express'].count - 3.0 # Remove backend, frontend and 'filler'
    sessions = ha.stats['express']['BACKEND'].scur.to_f
    sessions_per_gear = sessions / gear_count
    session_capacity_pct = (sessions_per_gear / @max_sessions_per_gear ) * 100
    
    if session_capacity_pct >= @gear_up_pct
        @log.info("GEAR_UP - capacity: #{session_capacity_pct}% gear_count:#{gear_count} sessions: #{sessions} up_threshold: #{@gear_up_pct}%")
        # Replace with jhonce's scripts
        `add-gear -l mmcgrath@redhat.com -p ' ' -n #{gear_namespace} -t php-5.3 -h localhost -a #{ENV['OPENSHIFT_APP_NAME']}`
    elsif session_capacity_pct < @gear_down_pct and gear_count > 1
        @log.info("GEAR_DOWN - capacity: #{session_capacity_pct}% gear_count:#{gear_count} sessions: #{sessions} down_threshold: #{@gear_down_pct}%")
        `remove-gear -l mmcgrath@redhat.com -p ' ' -n #{gear_namespace} -t php-5.3 -h localhost -a #{ENV['OPENSHIFT_APP_NAME']}`
    else
        @log.debug("GEAR_DO_NOTHING - Capacity: #{session_capacity_pct}% gear_count:#{gear_count} sessions: #{sessions} up/down_threshold: #{@gear_up_pct}%/#{@gear_down_pct}%")
    end
end

@log.info("Haproxy watcher started")

while true
    check_capacity
    sleep 3
end
