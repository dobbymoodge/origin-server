#!/usr/bin/ruby

require 'rubygems'
require 'libra'
require 'mcollective'
require 'json'

include MCollective::RPC
include Libra

options = rpcoptions do |parser, options|
    parser.define_head "Create a new user"
    parser.banner = "Usage: rhc-new-user [options]"

    parser.on('-l', '--rhlogin RHLOGIN', "The Red Hat login") do |rhlogin|
      options[:rhlogin] = rhlogin
    end

    parser.on('-n', '--namespace NAMESPACE', 'The unique namespace') do |namespace|
      options[:namespace] = namespace
    end

    parser.on('-s', '--ssh SSH_KEY', 'The user public SSH key') do |ssh|
      options[:ssh] = ssh
    end

    parser.on('-a', '--alter', 'Alter / Update user info') do
      options[:alter] = true
    end
    
    parser.on('-p', '--password PASSWORD', 'The user password') do |password|
      options[:password] = password
    end
end

unless options.include?(:namespace) or options[:namespace] =~ /^[a-zA-Z0-9]+$/
    puts "The namespace is invalid."
    exit 254
end

unless options.include?(:rhlogin) or options[:rhlogin] =~ /^[a-zA-Z][\w\.-]*[a-zA-Z0-9]@[a-zA-Z0-9][\w\.-]*[a-zA-Z0-9]\.[a-zA-Z][a-zA-Z\.]*[a-zA-Z]$/
    puts "The rhlogin is invalid."
    exit 253
end

unless options.include?(:ssh) or options[:ssh] =~ (options[:ssh] == Base64.encode64(Base64.decode64(options[:ssh])).gsub(/\n/, ''))
    puts "The ssh key is invalid."
    exit 252
end

unless options.include?(:password)
    puts "The password is missing."
    exit 251
end

# Set the MCollective options
Libra.c[:rpc_opts] = options

# Check if user already exists
user = User.find(options[:rhlogin])
if user
  if options[:alter]
    user.namespace=options[:namespace]
    user.ssh=options[:ssh]
    user.update
    Server.execute_many('li-controller-0.1', 'configure',
        "-c #{user.uuid} -e #{user.rhlogin} -s #{user.ssh}",
        "customer_#{user.rhlogin}", user.rhlogin)
  else
    puts "User already has a registered namespace.  To overwrite or change, use --alter"
    exit 254
  end
else
  if User.valid_registration?(options[:rhlogin], options[:password])
    user = User.create(options[:rhlogin], options[:ssh], options[:namespace])
  else
    puts "User registration invalid"
    exit 250
  end
end

json_return = JSON.generate({
                        :rhlogin => user.rhlogin,
                        :uuid => user.uuid
                        })

puts json_return