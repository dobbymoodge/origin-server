#!/usr/bin/ruby

require 'rubygems'
require 'libra'
require 'mcollective'

include MCollective::RPC
include Libra

options = rpcoptions do |parser, options|
    parser.define_head "Create a new user"
    parser.banner = "Usage: mc-libra [options]"

    parser.on('-u', '--username USERNAME', "The unique username") do |username|
      options[:username] = username
    end

    parser.on('-i', '--info', 'Display user info') do
      options[:info] = true
    end

    parser.on('-a', '--pps', 'App list') do
      options[:apps] = true
    end
end

# Set the MCollective options
Libra.c[:rpc_opts] = options

# Check if user already exists
user = User.find(options[:username])
if user
  if options[:info]
    puts "Username: #{user.username}"
    puts "Email: #{user.email}"
    puts "SSH key: #{user.ssh}"
  end
  if options[:apps]
    user.apps.each do |key, app|
      puts "#{key}.#{user.username}"
      puts "    Framework: #{app['framework']}"
      puts "    Creation: #{app['creation_time']}"
    end
  end
else
  puts "User could not be found"
  exit 253
end
