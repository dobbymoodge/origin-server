#!/usr/bin/ruby

require 'rubygems'
require 'libra'
require 'mcollective'

include MCollective::RPC
include Libra

options = rpcoptions do |parser, options|
    parser.define_head "Get info about a user"
    parser.banner = "Usage: rhc-get-user-info [options]"

    parser.on('-n', '--namespace NAMESPACE', "The unique namespace") do |namespace|
      options[:namepsace] = namespace
    end
end

# Set the MCollective options
Libra.c[:rpc_opts] = options

# Check if namespace already exists
user = User.find(options[:namespace])
unless user
    puts "Could not find user with namespace #{options[:namespace]}"
    exit 5
end
user_info = {
    :username => user.username,
    :uuid => user.uuid,
    :email => user.email,
    :ssh_key => user.ssh
    }

app_info = {}

user.apps.each do |key, app|
    app_info[key] = {
        :framework => app['framework'],
        :creation_time => app['creation_time']
    }
end

json_data = JSON.generate(
                {:user_info => user_info,
                 :app_info => app_info})

puts json_data
